# Deployment Readiness Check
# Verifies the project is ready for Cloudflare Pages deployment

name: Deploy Check

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  deploy-check:
    name: Deployment Readiness
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Check required files exist
        run: |
          echo "Checking required files..."
          
          required_files=(
            "index.html"
            "admin.html"
            "admin-v2.html"
            "404.html"
            "_headers"
            "robots.txt"
            "functions/api/auth.js"
            "functions/api/save.js"
            "functions/api/health.js"
            "data/demo/schema.json"
            "data/demo/content.json"
          )
          
          missing=0
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "MISSING: $file"
              missing=$((missing + 1))
            else
              echo "OK: $file"
            fi
          done
          
          if [ $missing -gt 0 ]; then
            echo "ERROR: $missing required files missing"
            exit 1
          fi
          
          echo "All required files present"
      
      - name: Check functions structure
        run: |
          echo "Checking Cloudflare Functions structure..."
          
          # Verify functions directory exists
          if [ ! -d "functions/api" ]; then
            echo "ERROR: functions/api directory missing"
            exit 1
          fi
          
          # Count function files
          count=$(ls -1 functions/api/*.js 2>/dev/null | wc -l)
          echo "Found $count function files"
          
          if [ "$count" -lt 3 ]; then
            echo "ERROR: Expected at least 3 function files"
            exit 1
          fi
          
          echo "Functions structure OK"
      
      - name: Check data directory
        run: |
          echo "Checking data directory structure..."
          
          # Verify demo page exists
          if [ ! -d "data/demo" ]; then
            echo "ERROR: data/demo directory missing"
            exit 1
          fi
          
          # Verify schema and content
          if [ ! -f "data/demo/schema.json" ]; then
            echo "ERROR: Demo schema missing"
            exit 1
          fi
          
          if [ ! -f "data/demo/content.json" ]; then
            echo "ERROR: Demo content missing"
            exit 1
          fi
          
          echo "Data directory OK"
      
      - name: Validate _headers file
        run: |
          echo "Checking _headers configuration..."
          
          # Check for security headers
          if ! grep -q "X-Frame-Options" _headers; then
            echo "WARNING: X-Frame-Options header missing"
          fi
          
          if ! grep -q "X-Content-Type-Options" _headers; then
            echo "WARNING: X-Content-Type-Options header missing"
          fi
          
          echo "_headers check complete"
      
      - name: Validate robots.txt
        run: |
          echo "Checking robots.txt..."
          
          # Verify admin pages are blocked
          if ! grep -q "admin.html" robots.txt; then
            echo "WARNING: admin.html not blocked in robots.txt"
          fi
          
          if ! grep -q "admin-v2.html" robots.txt; then
            echo "WARNING: admin-v2.html not blocked in robots.txt"
          fi
          
          if ! grep -q "/api/" robots.txt; then
            echo "WARNING: /api/ not blocked in robots.txt"
          fi
          
          echo "robots.txt check complete"
      
      - name: Summary
        run: |
          echo ""
          echo "=================================="
          echo "Deployment Readiness Check Complete"
          echo "=================================="
          echo ""
          echo "Ready for Cloudflare Pages deployment!"
          echo ""
          echo "Next steps:"
          echo "1. Create Cloudflare Pages project"
          echo "2. Add environment variables:"
          echo "   - GITHUB_REPO"
          echo "   - GITHUB_TOKEN"
          echo "   - USER_DEMO_PASSWORD"
          echo "3. Deploy!"
