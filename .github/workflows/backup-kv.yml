name: Backup KV State

on:
  schedule:
    - cron: '30 2 * * *'
  workflow_dispatch:

jobs:
  backup-kv:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Verify required secrets
        run: |
          if [ -z "${{ secrets.CF_API_TOKEN }}" ] || [ -z "${{ secrets.CF_ACCOUNT_ID }}" ] || [ -z "${{ secrets.KV_NAMESPACE_ID }}" ]; then
            echo "Skipping KV backup: set CF_API_TOKEN, CF_ACCOUNT_ID, and KV_NAMESPACE_ID secrets to enable."
            exit 0
          fi

      - name: Create KV backup
        id: kvbackup
        env:
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          KV_NAMESPACE_ID: ${{ secrets.KV_NAMESPACE_ID }}
          KV_BACKUP_OUT: backups/kv-backup-${{ github.run_number }}.json
        run: |
          npm ci
          npm run backup:kv
          echo "backup_file=backups/kv-backup-${{ github.run_number }}.json" >> $GITHUB_OUTPUT

      - name: Upload KV backup as release asset
        if: success() && steps.kvbackup.outputs.backup_file != ''
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "kv-backup-${{ github.run_number }}"
          files: ${{ steps.kvbackup.outputs.backup_file }}
          body: |
            # KV State Backup

            - Date: ${{ github.event.repository.updated_at }}
            - Commit: ${{ github.sha }}
            - File: ${{ steps.kvbackup.outputs.backup_file }}

            Restore command:
            ```bash
            export CF_API_TOKEN=...
            export CF_ACCOUNT_ID=...
            export KV_NAMESPACE_ID=...
            npm run restore:kv -- backups/kv-backup-XXXX.json
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

