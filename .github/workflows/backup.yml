name: Backup Content

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  backup:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better backup
          
      - name: Create backup archive
        id: backup
        run: |
          BACKUP_DATE=$(date +%Y-%m-%d_%H-%M-%S)
          BACKUP_FILE="backup-${BACKUP_DATE}.tar.gz"
          
          # Archive the data directory (content)
          if [ -d "data" ]; then
            tar -czf "$BACKUP_FILE" data/
            echo "backup_file=$BACKUP_FILE" >> $GITHUB_OUTPUT
            echo "Backup created: $BACKUP_FILE"
          else
            echo "No data directory found"
            exit 1
          fi
          
      - name: Upload backup as release asset
        if: success()
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "backup-${{ github.run_number }}"
          files: ${{ steps.backup.outputs.backup_file }}
          body: |
            # Content Backup
            
            - **Date**: ${{ github.event.repository.updated_at }}
            - **Commit**: ${{ github.sha }}
            - **Size**: See asset below
            
            ## Restore from Backup
            
            ```bash
            # Extract backup
            tar -xzf backup-*.tar.gz
            
            # Commit restored content
            git add data/
            git commit -m "Restore from backup"
            git push
            ```
            
            ## Verify Backup Integrity
            
            ```bash
            tar -tzf backup-*.tar.gz | head -20
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Clean up old backups (keep last 30 days)
        uses: actions/github-script@v7
        with:
          script: |
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            
            const releases = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            
            for (const release of releases.data) {
              if (release.tag_name.startsWith('backup-')) {
                const releaseDate = new Date(release.created_at);
                if (releaseDate < thirtyDaysAgo) {
                  console.log(`Deleting old backup: ${release.tag_name}`);
                  await github.rest.repos.deleteRelease({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    release_id: release.id,
                  });
                }
              }
            }
      
      - name: Notify backup status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "Backup completed successfully"
          else
            echo "Backup failed - check logs"
          fi
