<!DOCTYPE html>
<!--
================================================================================
LOON Admin Panel (admin.html) - Phase 1: Directory Mode
================================================================================

This is the content editor interface for LOON Phase 1 (Directory Mode).
Users authenticate with a Page ID + Password combination, where each page
has its own password stored as a Cloudflare environment variable.

FEATURES:
- Dynamic form generation from schema.json
- Auto-save drafts to localStorage
- Dark mode support (follows system preference)
- Session persistence ("Remember me")
- Keyboard shortcuts (Ctrl+S to save, ? for help)
- Image preview for URL fields
- Character counter for text fields

AUTHENTICATION:
- Password stored as USER_{PAGEID}_PASSWORD environment variable
- Validated against /api/auth endpoint
- Sent with every save request to /api/save

FOR PHASE 2 (TEAM MODE):
Use admin-v2.html instead, which supports:
- Username/password login (stored in KV)
- Session tokens
- Role-based access control
- User management UI

VERSION: 2.0.0
================================================================================
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LOON Admin</title>
    <meta name="description" content="LOON Admin Panel - Edit your content">
    <meta name="robots" content="noindex, nofollow">
    <meta name="theme-color" content="#003865">
    <meta name="color-scheme" content="light dark">
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='40' fill='%23003865'/><text x='50' y='62' text-anchor='middle' fill='white' font-size='40' font-family='sans-serif'>L</text></svg>">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <style>
        :root {
            --primary: #003865;
            --primary-hover: #004d8f;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --info: #17a2b8;
            --bg-gradient-start: #f8f9fa;
            --bg-gradient-end: #e9ecef;
            --card-bg: white;
            --text-primary: #333;
            --text-secondary: #6c757d;
            --border-color: #f0f0f0;
        }
        
        /* Dark mode */
        @media (prefers-color-scheme: dark) {
            :root {
                --bg-gradient-start: #1a1a2e;
                --bg-gradient-end: #16213e;
                --card-bg: #1f2937;
                --text-primary: #e5e7eb;
                --text-secondary: #9ca3af;
                --border-color: #374151;
            }
            .status-success { background: #064e3b; color: #6ee7b7; border-color: #065f46; }
            .status-error { background: #7f1d1d; color: #fca5a5; border-color: #991b1b; }
            .status-info { background: #1e3a5f; color: #93c5fd; border-color: #1e40af; }
            .status-warning { background: #78350f; color: #fcd34d; border-color: #92400e; }
        }
        
        * { box-sizing: border-box; }
        
        body {
            background: linear-gradient(180deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            min-height: 100vh;
            margin: 0;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 1rem;
        }
        
        .card {
            background: var(--card-bg);
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            margin-top: 1.5rem;
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .hidden { display: none !important; }
        
        /* Status Messages */
        .status-message {
            margin-top: 1rem;
            padding: 0.85rem 1rem;
            border-radius: 8px;
            font-weight: 500;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .status-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status-info { background: #cce5ff; color: #004085; border: 1px solid #b8daff; }
        .status-warning { background: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
        
        /* Header */
        .header {
            text-align: center;
            padding: 1.5rem 0 0.5rem 0;
        }
        .header h1 {
            margin-bottom: 0.25rem;
            color: var(--primary);
            font-size: 1.75rem;
        }
        @media (prefers-color-scheme: dark) {
            .header h1 { color: #60a5fa; }
        }
        .header p {
            color: var(--text-secondary);
            margin: 0;
            font-size: 0.95rem;
        }
        
        /* Form Improvements */
        label {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }
        
        input, select, textarea {
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        input:focus, select:focus, textarea:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 56, 101, 0.1);
        }
        
        textarea {
            min-height: 120px;
            resize: vertical;
        }
        
        /* Password field with toggle */
        .password-wrapper {
            position: relative;
        }
        .password-wrapper input {
            padding-right: 45px;
        }
        .password-toggle {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        .password-toggle:hover {
            color: var(--text-primary);
        }
        
        /* Login Form */
        .login-form h3 {
            margin-top: 0;
            color: var(--primary);
        }
        @media (prefers-color-scheme: dark) {
            .login-form h3 { color: #60a5fa; }
        }
        
        /* Remember me checkbox */
        .remember-me {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 1rem 0;
            font-size: 0.9rem;
        }
        .remember-me input {
            width: auto;
            margin: 0;
        }
        
        /* Editor Header */
        .editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border-color);
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .editor-title {
            margin: 0;
            color: var(--primary);
            font-size: 1.25rem;
        }
        @media (prefers-color-scheme: dark) {
            .editor-title { color: #60a5fa; }
        }
        .editor-meta {
            display: flex;
            gap: 1rem;
            align-items: center;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        .logout-link {
            font-size: 0.9rem;
            color: var(--text-secondary);
            text-decoration: none;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            transition: background 0.2s;
        }
        .logout-link:hover {
            background: var(--border-color);
            color: var(--text-primary);
        }
        
        /* Last saved indicator */
        .last-saved {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
        }
        .autosave-indicator {
            font-size: 0.75rem;
            color: var(--info);
            margin-left: 0.5rem;
        }
        
        /* Buttons */
        .btn-group {
            display: flex;
            gap: 0.75rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
        }
        
        button {
            font-weight: 500;
            transition: transform 0.1s, box-shadow 0.2s;
        }
        button:active {
            transform: scale(0.98);
        }
        
        .btn-secondary {
            background: #6c757d;
            border-color: #6c757d;
        }
        .btn-secondary:hover {
            background: #5a6268;
            border-color: #545b62;
        }
        .btn-small {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
        }
        
        /* Field descriptions and counters */
        .field-description {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
            margin-bottom: 0.75rem;
        }
        .field-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 0.25rem;
        }
        .char-counter {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        .char-counter.warning { color: var(--warning); }
        .char-counter.danger { color: var(--danger); }
        
        /* Image preview */
        .image-preview {
            margin-top: 0.5rem;
            max-width: 200px;
            max-height: 150px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            display: none;
        }
        .image-preview.loaded {
            display: block;
        }
        
        /* Field wrapper */
        .field-wrapper {
            margin-bottom: 1.25rem;
        }
        
        /* Footer */
        .footer-links {
            text-align: center;
            margin-top: 1.5rem;
            padding-top: 1rem;
            font-size: 0.85rem;
            color: #888;
        }
        .footer-links a {
            color: var(--text-secondary);
            margin: 0 0.5rem;
        }
        
        /* Version badge */
        .version-badge {
            display: inline-block;
            font-size: 0.7rem;
            background: var(--border-color);
            color: var(--text-secondary);
            padding: 0.15rem 0.4rem;
            border-radius: 4px;
            margin-left: 0.5rem;
            vertical-align: middle;
        }
        
        /* Help button */
        .help-btn {
            background: none;
            border: 1px solid var(--border-color);
            border-radius: 50%;
            width: 28px;
            height: 28px;
            font-size: 0.9rem;
            cursor: pointer;
            color: var(--text-secondary);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-left: 0.5rem;
            vertical-align: middle;
        }
        .help-btn:hover {
            background: var(--border-color);
            color: var(--text-primary);
        }
        
        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
        }
        .modal {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 2rem;
            max-width: 450px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal h3 {
            margin-top: 0;
            color: var(--primary);
        }
        @media (prefers-color-scheme: dark) {
            .modal h3 { color: #60a5fa; }
        }
        .modal table {
            width: 100%;
            font-size: 0.9rem;
        }
        .modal kbd {
            background: var(--border-color);
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.85rem;
        }
        
        /* Loading spinner in button */
        button[aria-busy="true"]::before {
            content: '';
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 0.5rem;
            vertical-align: middle;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Mobile improvements */
        @media (max-width: 600px) {
            .container { padding: 0.75rem; }
            .card { padding: 1.5rem; }
            .btn-group { flex-direction: column; }
            .btn-group button { width: 100%; }
            .editor-header { flex-direction: column; align-items: flex-start; }
            .editor-meta { width: 100%; justify-content: space-between; }
        }
    </style>
</head>
<body>
    <main class="container">
        <header class="header">
            <h1>
                Project LOON 
                <span class="version-badge">v2.0.0</span>
                <button class="help-btn" onclick="showHelp()" title="Keyboard shortcuts">?</button>
            </h1>
            <p>Lightweight Online Organizing Network</p>
        </header>
        
        <article class="card">
            <!-- LOGIN SECTION -->
            <div id="login-section" class="login-form">
                <h3>Sign In to Edit</h3>
                <form onsubmit="login(event)" autocomplete="on">
                    <div class="field-wrapper">
                        <label for="pageId">Page ID</label>
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="text" id="pageId" name="username" placeholder="e.g., demo" required autocomplete="username" autofocus style="flex: 1;">
                            <button type="button" class="outline" onclick="togglePageBrowser()" style="white-space: nowrap;">Browse</button>
                        </div>
                        <small class="field-description">The identifier for the page you want to edit</small>
                    </div>
                    
                    <!-- Page Browser -->
                    <div id="page-browser" class="hidden" style="margin-bottom: 1rem; padding: 1rem; background: var(--bg-gradient-start); border-radius: 8px; max-height: 200px; overflow-y: auto;">
                        <div id="page-list">Loading pages...</div>
                    </div>
                    
                    <div class="field-wrapper">
                        <label for="password">Password</label>
                        <div class="password-wrapper">
                            <input type="password" id="password" name="password" placeholder="Enter your password" required autocomplete="current-password">
                            <button type="button" class="password-toggle" onclick="togglePassword()" title="Show/hide password">
                                <span id="password-toggle-text">Show</span>
                            </button>
                        </div>
                    </div>
                    
                    <label class="remember-me">
                        <input type="checkbox" id="remember-me">
                        <span>Remember me on this device</span>
                    </label>
                    
                    <button type="submit" id="login-btn">Sign In</button>
                </form>
                <div id="login-status" class="status-message hidden" role="alert" aria-live="polite"></div>
            </div>

            <!-- EDITOR SECTION -->
            <div id="editor-section" class="hidden">
                <div class="editor-header">
                    <h3 class="editor-title" id="editor-title">Editing...</h3>
                    <div class="editor-meta">
                        <span id="last-saved" class="last-saved"></span>
                        <a href="#" class="logout-link" onclick="logout(); return false;" aria-label="Sign out">Sign Out</a>
                    </div>
                </div>
                
                <form id="dynamic-form" onsubmit="saveData(event)"></form>
                
                <div class="btn-group">
                    <button type="button" onclick="saveData(event)" id="save-btn" class="primary">Save Changes</button>
                    <button type="button" onclick="previewChanges()" class="btn-secondary outline">Preview</button>
                </div>
                
                <div id="status" class="status-message hidden" role="alert" aria-live="polite"></div>
                <div id="autosave-status" class="last-saved"></div>
            </div>
        </article>
        
        <footer class="footer-links">
            <a href="/">View Public Site</a>
            <span>|</span>
            <a href="/api/health" target="_blank">System Health</a>
            <span>|</span>
            <a href="#" onclick="showHelp(); return false;">Shortcuts</a>
            <br>
            <small style="opacity: 0.6; margin-top: 0.5rem; display: inline-block;">Phase 1: Directory Mode</small>
        </footer>
    </main>
    
    <!-- Help Modal -->
    <div id="help-modal" class="modal-overlay hidden" onclick="if(event.target === this) hideHelp()">
        <div class="modal">
            <h3>Keyboard Shortcuts</h3>
            <table>
                <tr><td><kbd>Ctrl</kbd> + <kbd>S</kbd></td><td>Save changes</td></tr>
                <tr><td><kbd>Esc</kbd></td><td>Sign out (with confirmation)</td></tr>
            </table>
            
            <h3 style="margin-top: 1.5rem;">Features</h3>
            <ul style="font-size: 0.9rem; color: var(--text-secondary);">
                <li><strong>Auto-save:</strong> Drafts saved locally every 30 seconds</li>
                <li><strong>Remember me:</strong> Stay signed in on this device</li>
                <li><strong>Image preview:</strong> URL fields show image thumbnails</li>
                <li><strong>Dark mode:</strong> Follows your system preference</li>
            </ul>
            
            <h3 style="margin-top: 1.5rem;">Limits</h3>
            <ul style="font-size: 0.9rem; color: var(--text-secondary);">
                <li>Max content size: 1 MB</li>
                <li>Rate limit: 30 saves per minute</li>
                <li>Auth rate limit: 10 attempts per minute</li>
            </ul>
            
            <button onclick="hideHelp()" style="margin-top: 1rem; width: 100%;">Close</button>
        </div>
    </div>

    <script>
        // =====================
        // STATE
        // =====================
        /**
         * Application state for the admin editor.
         *
         * Security note: CURRENT_PASSWORD is held in memory only during the
         * active session. The "Remember me" feature stores a hashed session
         * token, not the raw password, to reduce exposure if localStorage
         * is compromised.
         */
        let CURRENT_SCHEMA = null;
        let CURRENT_CONTENT = null;
        let CURRENT_PAGE_ID = null;
        let CURRENT_PASSWORD = null;
        let hasUnsavedChanges = false;
        let lastSavedTime = null;
        let autosaveInterval = null;

        const STORAGE_KEYS = {
            SESSION: 'loon_session_v2',  // Session token (not raw password)
            DRAFT: 'loon_draft_',
            LAST_PAGE: 'loon_last_page'
        };

        /**
         * Generate a session token from credentials.
         * This creates a non-reversible token stored in localStorage instead
         * of the raw password. The token is page-specific and time-bound.
         *
         * Note: This is a client-side convenience token for "Remember me",
         * not a cryptographic session. The actual password is still sent
         * to the server on each save request.
         *
         * @param {string} pageId - The page identifier
         * @param {string} password - The user's password
         * @param {number} timestamp - Session creation time
         * @returns {Promise<string>} A hex-encoded session token
         */
        async function generateSessionToken(pageId, password, timestamp) {
            const data = `${pageId}:${password}:${timestamp}`;
            const encoder = new TextEncoder();
            const hashBuffer = await crypto.subtle.digest('SHA-256', encoder.encode(data));
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        /**
         * Verify a session token matches the provided credentials.
         * Used to validate stored "Remember me" sessions.
         *
         * @param {string} token - The stored session token
         * @param {string} pageId - The page identifier
         * @param {string} password - The password to verify
         * @param {number} timestamp - The original session timestamp
         * @returns {Promise<boolean>} True if token matches credentials
         */
        async function verifySessionToken(token, pageId, password, timestamp) {
            const expected = await generateSessionToken(pageId, password, timestamp);
            return token === expected;
        }

        // =====================
        // INITIALIZATION
        // =====================
        document.addEventListener('DOMContentLoaded', () => {
            // Check for saved session
            // Note: We store a hashed token, not the raw password.
            // The user must re-enter credentials if the session is invalid.
            const session = localStorage.getItem(STORAGE_KEYS.SESSION);
            if (session) {
                try {
                    const parsed = JSON.parse(session);
                    const { pageId, token, timestamp } = parsed;

                    // Session valid for 7 days
                    const SESSION_MAX_AGE_MS = 7 * 24 * 60 * 60 * 1000;
                    if (Date.now() - timestamp < SESSION_MAX_AGE_MS) {
                        // Store session data for later validation
                        // User will need to enter password; we pre-fill pageId only
                        document.getElementById('pageId').value = pageId;
                        document.getElementById('remember-me').checked = true;

                        // Store the token for verification after login
                        window._pendingSessionToken = token;
                        window._pendingSessionTimestamp = timestamp;
                    } else {
                        // Session expired, clear it
                        localStorage.removeItem(STORAGE_KEYS.SESSION);
                    }
                } catch (e) {
                    localStorage.removeItem(STORAGE_KEYS.SESSION);
                }
            }

            // Restore last used page ID (if not already set by session)
            if (!document.getElementById('pageId').value) {
                const lastPage = localStorage.getItem(STORAGE_KEYS.LAST_PAGE);
                if (lastPage) {
                    document.getElementById('pageId').value = lastPage;
                }
            }

            // Migrate old session format (v1 stored raw password)
            // This removes any legacy sessions that stored passwords
            migrateOldSessions();
        });

        /**
         * Migrate sessions from old format (v1) that stored raw passwords.
         * This is a one-time cleanup to remove any stored passwords from
         * before the session token update.
         */
        function migrateOldSessions() {
            const oldKey = 'loon_session';
            const oldSession = localStorage.getItem(oldKey);
            if (oldSession) {
                try {
                    const parsed = JSON.parse(oldSession);
                    // Old format had 'password' field; new format has 'token'
                    if (parsed.password) {
                        // Remove the old session with stored password
                        localStorage.removeItem(oldKey);
                    }
                } catch (e) {
                    localStorage.removeItem(oldKey);
                }
            }
        }

        // =====================
        // PAGE BROWSER
        // =====================
        let pageBrowserLoaded = false;
        
        async function togglePageBrowser() {
            const browser = document.getElementById('page-browser');
            const isHidden = browser.classList.contains('hidden');
            
            if (isHidden) {
                browser.classList.remove('hidden');
                if (!pageBrowserLoaded) {
                    await loadPageList();
                }
            } else {
                browser.classList.add('hidden');
            }
        }
        
        async function loadPageList() {
            const list = document.getElementById('page-list');
            list.innerHTML = 'Loading pages...';
            
            try {
                const res = await fetch('/api/pages');
                const data = await res.json();
                
                if (!res.ok) {
                    throw new Error(data.error || 'Failed to load pages');
                }
                
                if (data.pages.length === 0) {
                    list.innerHTML = '<p style="color: var(--text-secondary); margin: 0;">No pages found.</p>';
                    return;
                }
                
                list.innerHTML = data.pages.map(page => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; margin-bottom: 0.5rem; background: var(--card-bg); border-radius: 4px; border: 1px solid var(--border-color);">
                        <div>
                            <strong>${escapeHtml(page.title)}</strong>
                            <small style="color: var(--text-secondary); margin-left: 0.5rem;">${escapeHtml(page.pageId)}</small>
                        </div>
                        <button type="button" onclick="selectPage('${escapeHtml(page.pageId)}')" class="outline" style="padding: 0.25rem 0.75rem; font-size: 0.85rem;">Select</button>
                    </div>
                `).join('');
                
                pageBrowserLoaded = true;
                
            } catch (e) {
                list.innerHTML = `<p style="color: var(--danger); margin: 0;">${escapeHtml(e.message)}</p>`;
            }
        }
        
        function selectPage(pageId) {
            document.getElementById('pageId').value = pageId;
            document.getElementById('page-browser').classList.add('hidden');
            document.getElementById('password').focus();
        }
        
        function escapeHtml(str) {
            if (!str) return '';
            return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }

        // =====================
        // PASSWORD TOGGLE
        // =====================
        function togglePassword() {
            const input = document.getElementById('password');
            const toggle = document.getElementById('password-toggle-text');
            if (input.type === 'password') {
                input.type = 'text';
                toggle.innerText = 'Hide';
            } else {
                input.type = 'password';
                toggle.innerText = 'Show';
            }
        }

        // =====================
        // HELP MODAL
        // =====================
        function showHelp() {
            document.getElementById('help-modal').classList.remove('hidden');
        }
        
        function hideHelp() {
            document.getElementById('help-modal').classList.add('hidden');
        }

        // =====================
        // LOGIN FLOW
        // =====================
        async function login(event) {
            if (event) event.preventDefault();
            
            const pageId = document.getElementById('pageId').value.trim().toLowerCase();
            const password = document.getElementById('password').value;
            const rememberMe = document.getElementById('remember-me').checked;
            const btn = document.getElementById('login-btn');
            const status = document.getElementById('login-status');
            
            if (!pageId || !password) {
                showStatus(status, 'Please enter both Page ID and Password', 'error');
                return;
            }
            
            btn.setAttribute('aria-busy', 'true');
            btn.disabled = true;
            hideStatus(status);

            try {
                // 1. Validate password with server
                const authRes = await fetch('/api/auth', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pageId, password })
                });
                
                if (!authRes.ok) {
                    const authErr = await authRes.json();
                    throw new Error(authErr.error || 'Invalid credentials');
                }

                // 2. Load Schema
                const schemaRes = await fetch(`/data/${pageId}/schema.json`);
                if (!schemaRes.ok) throw new Error(`Page "${pageId}" not found`);
                CURRENT_SCHEMA = await schemaRes.json();

                // 3. Load Content (try draft first, then server)
                const draftKey = STORAGE_KEYS.DRAFT + pageId;
                const draft = localStorage.getItem(draftKey);
                let contentFromDraft = false;
                
                const contentRes = await fetch(`/data/${pageId}/content.json`);
                CURRENT_CONTENT = contentRes.ok ? await contentRes.json() : {};
                
                // Check if draft is newer
                if (draft) {
                    try {
                        const draftData = JSON.parse(draft);
                        const serverTime = CURRENT_CONTENT._meta?.lastModified ? new Date(CURRENT_CONTENT._meta.lastModified).getTime() : 0;
                        if (draftData._draftTime > serverTime) {
                            CURRENT_CONTENT = draftData.content;
                            contentFromDraft = true;
                        }
                    } catch (e) {
                        localStorage.removeItem(draftKey);
                    }
                }

                // 4. Store credentials in memory (not localStorage)
                CURRENT_PAGE_ID = pageId;
                CURRENT_PASSWORD = password;

                // Save session token if "Remember me" is checked
                // Security: We store a hashed token derived from credentials,
                // not the raw password. This limits exposure if localStorage
                // is accessed by malicious scripts or browser extensions.
                if (rememberMe) {
                    const timestamp = Date.now();
                    const token = await generateSessionToken(pageId, password, timestamp);
                    localStorage.setItem(STORAGE_KEYS.SESSION, JSON.stringify({
                        pageId,
                        token,
                        timestamp
                    }));
                }
                localStorage.setItem(STORAGE_KEYS.LAST_PAGE, pageId);

                // Clear any pending session verification data
                delete window._pendingSessionToken;
                delete window._pendingSessionTimestamp;

                // 5. Build Form
                buildForm(CURRENT_SCHEMA, CURRENT_CONTENT);
                
                // 6. Show Editor
                document.getElementById('login-section').classList.add('hidden');
                document.getElementById('editor-section').classList.remove('hidden');
                document.getElementById('editor-title').innerText = CURRENT_SCHEMA.title || `Editing: ${pageId}`;
                
                // Show draft notice
                if (contentFromDraft) {
                    showStatus(document.getElementById('status'), 'Restored from local draft. Save to publish.', 'warning');
                }
                
                // Update last saved display
                updateLastSaved();
                
                // Start autosave
                startAutosave();
                
            } catch (err) {
                showStatus(status, err.message, 'error');
            } finally {
                btn.setAttribute('aria-busy', 'false');
                btn.disabled = false;
            }
        }

        function logout() {
            // Clear autosave
            if (autosaveInterval) {
                clearInterval(autosaveInterval);
                autosaveInterval = null;
            }
            
            // Clear state
            CURRENT_SCHEMA = null;
            CURRENT_CONTENT = null;
            CURRENT_PAGE_ID = null;
            CURRENT_PASSWORD = null;
            hasUnsavedChanges = false;
            
            // Clear session if not remember me
            if (!document.getElementById('remember-me').checked) {
                localStorage.removeItem(STORAGE_KEYS.SESSION);
            }
            
            // Reset UI
            document.getElementById('password').value = '';
            document.getElementById('login-section').classList.remove('hidden');
            document.getElementById('editor-section').classList.add('hidden');
            hideStatus(document.getElementById('status'));
            hideStatus(document.getElementById('login-status'));
            document.getElementById('autosave-status').innerText = '';
        }

        // =====================
        // FORM BUILDER
        // =====================
        function buildForm(schema, content) {
            const form = document.getElementById('dynamic-form');
            form.innerHTML = '';

            schema.fields.forEach(field => {
                if (field.type === 'hidden') return;
                
                const wrapper = document.createElement('div');
                wrapper.className = 'field-wrapper';
                
                // Checkbox layout
                if (field.type === 'checkbox') {
                    const checkWrapper = document.createElement('label');
                    checkWrapper.style.cssText = 'display:flex;align-items:center;gap:0.5rem;cursor:pointer;';
                    
                    const input = document.createElement('input');
                    input.type = 'checkbox';
                    input.id = field.key;
                    input.name = field.key;
                    input.checked = content[field.key] === true || content[field.key] === 'true';
                    input.style.cssText = 'width:auto;margin:0;';
                    input.addEventListener('change', () => { hasUnsavedChanges = true; });
                    
                    const labelText = document.createElement('span');
                    labelText.innerText = field.label;
                    
                    checkWrapper.appendChild(input);
                    checkWrapper.appendChild(labelText);
                    wrapper.appendChild(checkWrapper);
                    
                    if (field.description) {
                        const desc = document.createElement('small');
                        desc.className = 'field-description';
                        desc.innerText = field.description;
                        wrapper.appendChild(desc);
                    }
                    
                    form.appendChild(wrapper);
                    return;
                }
                
                // Standard label
                const label = document.createElement('label');
                label.setAttribute('for', field.key);
                label.innerText = field.label;
                if (field.required) {
                    const req = document.createElement('span');
                    req.innerText = ' *';
                    req.style.color = '#dc3545';
                    label.appendChild(req);
                }
                wrapper.appendChild(label);
                
                // Create input
                let input;
                
                if (field.type === 'textarea') {
                    input = document.createElement('textarea');
                    input.rows = field.rows || 5;
                } else if (field.type === 'select') {
                    input = document.createElement('select');
                    if (!field.required) {
                        const emptyOpt = document.createElement('option');
                        emptyOpt.value = '';
                        emptyOpt.innerText = '-- Select --';
                        input.appendChild(emptyOpt);
                    }
                    (field.options || []).forEach(opt => {
                        const option = document.createElement('option');
                        option.value = opt;
                        option.innerText = opt;
                        if (content[field.key] === opt) option.selected = true;
                        input.appendChild(option);
                    });
                } else {
                    input = document.createElement('input');
                    const typeMap = {
                        'text': 'text', 'email': 'email', 'url': 'url',
                        'number': 'number', 'tel': 'tel', 'date': 'date',
                        'time': 'time', 'datetime': 'datetime-local'
                    };
                    input.type = typeMap[field.type] || 'text';
                }
                
                input.id = field.key;
                input.name = field.key;
                if (field.placeholder) input.placeholder = field.placeholder;
                if (field.required) input.required = true;
                if (field.maxlength) input.maxLength = field.maxlength;
                if (field.pattern) input.pattern = field.pattern;
                if (field.min !== undefined) input.min = field.min;
                if (field.max !== undefined) input.max = field.max;
                if (field.type !== 'select') input.value = content[field.key] || '';
                
                input.addEventListener('input', () => { hasUnsavedChanges = true; });
                
                wrapper.appendChild(input);
                
                // Field meta (description + character counter)
                const fieldMeta = document.createElement('div');
                fieldMeta.className = 'field-meta';
                
                if (field.description) {
                    const desc = document.createElement('small');
                    desc.className = 'field-description';
                    desc.innerText = field.description;
                    desc.style.margin = '0';
                    fieldMeta.appendChild(desc);
                } else {
                    fieldMeta.appendChild(document.createElement('span'));
                }
                
                // Character counter for text/textarea
                if ((field.type === 'text' || field.type === 'textarea') && field.maxlength) {
                    const counter = document.createElement('span');
                    counter.className = 'char-counter';
                    counter.id = `counter-${field.key}`;
                    updateCharCounter(input, counter, field.maxlength);
                    input.addEventListener('input', () => updateCharCounter(input, counter, field.maxlength));
                    fieldMeta.appendChild(counter);
                }
                
                if (fieldMeta.children.length > 0) {
                    wrapper.appendChild(fieldMeta);
                }
                
                // Image preview for URL fields
                if (field.type === 'url' && (field.key.includes('image') || field.key.includes('photo') || field.key.includes('logo') || field.key.includes('avatar'))) {
                    const preview = document.createElement('img');
                    preview.className = 'image-preview';
                    preview.id = `preview-${field.key}`;
                    preview.alt = 'Preview';
                    preview.onerror = () => { preview.classList.remove('loaded'); };
                    preview.onload = () => { preview.classList.add('loaded'); };
                    if (input.value) {
                        preview.src = input.value;
                    }
                    input.addEventListener('input', (e) => {
                        if (e.target.value) {
                            preview.src = e.target.value;
                        } else {
                            preview.classList.remove('loaded');
                        }
                    });
                    wrapper.appendChild(preview);
                }
                
                form.appendChild(wrapper);
            });
        }
        
        function updateCharCounter(input, counter, max) {
            const len = input.value.length;
            counter.innerText = `${len}/${max}`;
            counter.classList.remove('warning', 'danger');
            if (len > max * 0.9) counter.classList.add('danger');
            else if (len > max * 0.7) counter.classList.add('warning');
        }

        // =====================
        // AUTOSAVE
        // =====================
        function startAutosave() {
            autosaveInterval = setInterval(() => {
                if (hasUnsavedChanges && CURRENT_PAGE_ID) {
                    saveDraft();
                }
            }, 30000); // Every 30 seconds
        }
        
        function saveDraft() {
            const payload = gatherFormData();
            const draftKey = STORAGE_KEYS.DRAFT + CURRENT_PAGE_ID;
            localStorage.setItem(draftKey, JSON.stringify({
                content: payload,
                _draftTime: Date.now()
            }));
            document.getElementById('autosave-status').innerText = 'Draft saved locally';
            setTimeout(() => {
                const el = document.getElementById('autosave-status');
                if (el) el.innerText = '';
            }, 3000);
        }
        
        function clearDraft() {
            if (CURRENT_PAGE_ID) {
                localStorage.removeItem(STORAGE_KEYS.DRAFT + CURRENT_PAGE_ID);
            }
        }

        // =====================
        // SAVE DATA
        // =====================
        function gatherFormData() {
            const payload = {};
            CURRENT_SCHEMA.fields.forEach(field => {
                if (field.type === 'checkbox') {
                    const el = document.getElementById(field.key);
                    payload[field.key] = el ? el.checked : false;
                } else if (field.type === 'hidden') {
                    payload[field.key] = CURRENT_CONTENT?.[field.key] || field.default || '';
                } else if (field.type === 'number') {
                    const el = document.getElementById(field.key);
                    const val = el ? el.value : '';
                    payload[field.key] = val !== '' ? Number(val) : null;
                } else {
                    const el = document.getElementById(field.key);
                    payload[field.key] = el ? el.value : '';
                }
            });
            return payload;
        }
        
        async function saveData(event) {
            if (event) event.preventDefault();
            
            const btn = document.getElementById('save-btn');
            const status = document.getElementById('status');
            
            btn.setAttribute('aria-busy', 'true');
            btn.disabled = true;
            showStatus(status, 'Saving...', 'info');
            
            const payload = gatherFormData();
            payload._meta = {
                lastModified: new Date().toISOString(),
                modifiedBy: CURRENT_PAGE_ID
            };

            try {
                const res = await fetch('/api/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        pageId: CURRENT_PAGE_ID,
                        password: CURRENT_PASSWORD,
                        content: payload
                    })
                });

                const json = await res.json();
                
                if (!res.ok) {
                    throw new Error(json.error || 'Save failed');
                }
                
                hasUnsavedChanges = false;
                lastSavedTime = new Date();
                CURRENT_CONTENT = payload;
                clearDraft();
                updateLastSaved();
                showStatus(status, 'Saved. Changes will be live in about 60 seconds.', 'success');
                
            } catch (err) {
                showStatus(status, `Error: ${err.message}`, 'error');
            } finally {
                btn.setAttribute('aria-busy', 'false');
                btn.disabled = false;
            }
        }
        
        function updateLastSaved() {
            const el = document.getElementById('last-saved');
            if (CURRENT_CONTENT?._meta?.lastModified) {
                const date = new Date(CURRENT_CONTENT._meta.lastModified);
                el.innerText = `Last saved: ${formatRelativeTime(date)}`;
            } else {
                el.innerText = '';
            }
        }
        
        function formatRelativeTime(date) {
            const now = new Date();
            const diff = now - date;
            const mins = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (mins < 1) return 'just now';
            if (mins < 60) return `${mins}m ago`;
            if (hours < 24) return `${hours}h ago`;
            if (days < 7) return `${days}d ago`;
            return date.toLocaleDateString();
        }

        // =====================
        // PREVIEW
        // =====================
        function previewChanges() {
            window.open('/', '_blank', 'noopener');
        }

        // =====================
        // HELPERS
        // =====================
        function showStatus(element, message, type) {
            // Use textContent to prevent XSS from server error messages
            element.textContent = message;
            element.className = `status-message status-${type}`;
            element.classList.remove('hidden');
            
            if (type === 'success') {
                setTimeout(() => hideStatus(element), 5000);
            }
        }
        
        function hideStatus(element) {
            element.classList.add('hidden');
            element.textContent = '';
        }

        // =====================
        // KEYBOARD SHORTCUTS
        // =====================
        document.addEventListener('keydown', (e) => {
            // Ctrl/Cmd + S to save
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                if (!document.getElementById('editor-section').classList.contains('hidden')) {
                    saveData(e);
                }
            }
            // Escape to close modal or logout
            if (e.key === 'Escape') {
                if (!document.getElementById('help-modal').classList.contains('hidden')) {
                    hideHelp();
                } else if (!document.getElementById('editor-section').classList.contains('hidden')) {
                    if (!hasUnsavedChanges || confirm('You have unsaved changes. Sign out anyway?')) {
                        logout();
                    }
                }
            }
            // ? to show help
            if (e.key === '?' && !e.target.matches('input, textarea, select')) {
                showHelp();
            }
        });

        // Warn before leaving with unsaved changes
        window.addEventListener('beforeunload', (e) => {
            if (hasUnsavedChanges && !document.getElementById('editor-section').classList.contains('hidden')) {
                e.preventDefault();
                e.returnValue = '';
            }
        });
    </script>
</body>
</html>
